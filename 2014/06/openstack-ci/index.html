<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="openstack,ci,持续集成,"><meta name="description" content="本文档主要对Openstack社区目前的CI测试环境及其中用到的各个组件进行介绍。 测试的分类及必要性测试的分类测试的过程没太有太严格的分类标准，从使用的角度，我们可以从以下两个角度对测试进行分类。 按照测试过程分类软件测试大概分为单元测试、集成测试、系统测试、验收测试。以下为软件测试V型图：  一般由单元测试开始，集中对每一个程序单元进行测试，检查各个程序模块是否正确地实现了规定的功能。单元测试"><meta name="keywords" content="openstack,ci,持续集成"><meta property="og:type" content="article"><meta property="og:title" content="Openstack CI持续集成测试简介"><meta property="og:url" content="http://bingostack.com/2014/06/openstack-ci/index.html"><meta property="og:site_name" content="BingoStack"><meta property="og:description" content="本文档主要对Openstack社区目前的CI测试环境及其中用到的各个组件进行介绍。 测试的分类及必要性测试的分类测试的过程没太有太严格的分类标准，从使用的角度，我们可以从以下两个角度对测试进行分类。 按照测试过程分类软件测试大概分为单元测试、集成测试、系统测试、验收测试。以下为软件测试V型图：  一般由单元测试开始，集中对每一个程序单元进行测试，检查各个程序模块是否正确地实现了规定的功能。单元测试"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://bingostack.com/img/testing-V.png"><meta property="og:image" content="http://bingostack.com/img/testing-sorts-process.png"><meta property="og:image" content="http://bingostack.com/img/ci-process.png"><meta property="og:image" content="http://bingostack.com/img/gerrit-workflow.png"><meta property="og:image" content="http://bingostack.com/img/gerrit-patch.png"><meta property="og:image" content="http://bingostack.com/img/gerrit-patch-tabs.png"><meta property="og:image" content="http://bingostack.com/img/gerrit-patch-verify.png"><meta property="og:image" content="http://bingostack.com/img/git-branches.png"><meta property="og:image" content="http://bingostack.com/img/openstack-ci-process.png"><meta property="og:image" content="http://bingostack.com/img/openstack-ci-modules.png"><meta property="og:updated_time" content="2020-11-03T02:23:40.858Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Openstack CI持续集成测试简介"><meta name="twitter:description" content="本文档主要对Openstack社区目前的CI测试环境及其中用到的各个组件进行介绍。 测试的分类及必要性测试的分类测试的过程没太有太严格的分类标准，从使用的角度，我们可以从以下两个角度对测试进行分类。 按照测试过程分类软件测试大概分为单元测试、集成测试、系统测试、验收测试。以下为软件测试V型图：  一般由单元测试开始，集中对每一个程序单元进行测试，检查各个程序模块是否正确地实现了规定的功能。单元测试"><meta name="twitter:image" content="http://bingostack.com/img/testing-V.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://bingostack.com/2014/06/openstack-ci/"><title>Openstack CI持续集成测试简介 | BingoStack</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?9c95a77f4ec2c33edff8095251aef97d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">BingoStack</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Long way to full stack!</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://bingostack.com/2014/06/openstack-ci/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="bingostack"><meta itemprop="description" content><meta itemprop="image" content="/img/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="BingoStack"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Openstack CI持续集成测试简介</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-06-26T09:30:40+08:00">2014-06-26</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2020-11-03T10:23:40+08:00">2020-11-03</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/openstack/" itemprop="url" rel="index"><span itemprop="name">openstack</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">5.7k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">20</span></div></div></header><div class="post-body" itemprop="articleBody"><p>本文档主要对Openstack社区目前的CI测试环境及其中用到的各个组件进行介绍。</p><h2 id="测试的分类及必要性"><a href="#测试的分类及必要性" class="headerlink" title="测试的分类及必要性"></a>测试的分类及必要性</h2><h3 id="测试的分类"><a href="#测试的分类" class="headerlink" title="测试的分类"></a>测试的分类</h3><p>测试的过程没太有太严格的分类标准，从使用的角度，我们可以从以下两个角度对测试进行分类。</p><h4 id="按照测试过程分类"><a href="#按照测试过程分类" class="headerlink" title="按照测试过程分类"></a>按照测试过程分类</h4><p>软件测试大概分为单元测试、集成测试、系统测试、验收测试。以下为软件测试V型图：<br><img src="/img/testing-V.png" alt="软件测试V型图"></p><ul><li>一般由单元测试开始，集中对每一个程序单元进行测试，检查各个程序模块是否正确地实现了规定的功能。单元测试的测试对象为独立的模块，需要由开发完成。</li><li>此外，开发阶段应该还需要通过代码评审等方式，进行静态测试。</li><li>集成测试把已测试过的模块组装起来，主要对与设计相关的软件体系结构的构造进行测试，目的在于检验与软件设计相关的程序结构问题。系统测试把已经经过确认的软件纳入实际运行环境中，与其它系统成份组合在一起进行测试，验证软件的完整功能是否满足需求规格并可正常运行。此两个阶段应该由测试人员执行。</li><li>在软件的迭代过程中，需要不断重复测试以验证bug修改及新功能添加，这称之为回归测试。</li><li>为了快速验证一个新版本，可挑选部分重要测试用例（如出错后会导致阻断其它测试用例的用例）用来验证，称之为冒烟测试(Smoke Test)或接收测试。</li><li>验收测试主要由软件的实际用户在实际应用场景中执行，包含α测试和β测试。</li></ul><a id="more"></a><h4 id="按照测试侧重点的不同分类"><a href="#按照测试侧重点的不同分类" class="headerlink" title="按照测试侧重点的不同分类"></a>按照测试侧重点的不同分类</h4><p>测试可分为功能测试、稳定性测试、性能测试等。<br><img src="/img/testing-sorts-process.png" alt="测试分类及阶段"></p><ul><li>功能测试用以验证被测试对象功能的正确性。功能是软件最基础的属性，如果功能错误，其他一切测试都没有意义。因此功能测试是其他测试的前提。</li><li>性能测试用于验证被测试对象的最大服务负载及其他性能拐点，并通过调查、优化比较给出性能瓶颈、优化建议。</li><li>稳定性测试用于验证在一定负载压力情况下，被测试对象长时间运行时功能是否正常。与性能测试的差别在于，稳定性测试的负载不是100%，而且测试的目的在于验证负载下功能的正常，而非验证最大负载。</li><li>如果需要，还可以添加场景测试。即根据实际使用情况或猜想得到被测试物的使用场景，在使用场景中进行测试。</li><li>其他测试如安全测试、易用性测试，可根据实际需要添加。但是严格来讲，这些都属于功能测试的范畴。</li></ul><h2 id="软件测试的必要性"><a href="#软件测试的必要性" class="headerlink" title="软件测试的必要性"></a>软件测试的必要性</h2><p>发现软件的bug只是手段，软件测试的目的在于保证并提高产品质量。</p><p>如果产品继承自开源社区，开源社区一般有严格的测试标准（如openstack），但是我们仍然需要验证：</p><ul><li>我们的部署是否正确？</li><li>版本是否适用于我们的环境？有哪些不足值得我们改善？</li><li>针对某个bug的修改是否适用于我们的环境？</li><li>我们修改或新增后的新特性是否正确？对其他组件是否有影响？</li></ul><h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><h3 id="持续集成测试"><a href="#持续集成测试" class="headerlink" title="持续集成测试"></a>持续集成测试</h3><p>持续集成（Continuous integration）测试，是指在持续基础上不断执行测试以验证完整应用环境正确的行为。“持续”，即要求每次改变提交后，测试工作都要进行。因为需要不断进行回归测试，而且一般都对测试时间有一定要求，因此会大量使用自动化测试。<br><img src="/img/ci-process.png" alt="持续集成测试"></p><h3 id="为什么需要持续集成？"><a href="#为什么需要持续集成？" class="headerlink" title="为什么需要持续集成？"></a>为什么需要持续集成？</h3><p>如果项目开发的规模比较小，对外部系统的依赖很小，那么软件集成不是问题。但是随着软件项目复杂度的增加，就会对集成和确保软件组件能够在一起工作提出了更多的要求。如果开发人员在后期才进行集成，到后期才发现问题，解决问题代价会很大，很有可能导致项目延期或者项目失败。</p><p>因此要求“尽早集成、经常集成”，在早期发现项目风险和质量问题，更容易解决问题，并保证开发进度。持续集成就出现在这样的背景下。</p><p>持续集成测试是一种软件开发实践：团队开发成员经常集成他们的工作，每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。这个过程可以大大减少集成的问题，让团队能够更快的开发内聚的软件从而减少项目整体风险。</p><p>通常当我们提及CI的时候，我们指的是针对完整、现实使用的环境进行的测试。这种测试可以称为集成测试，可以确保提交的针对某个组件的修改不会导致其他组件的失效。集成测试对于如Openstack的多组件多项目的复杂系统尤为重要，而且适用于子系统间没有过多的耦合依赖的情况。</p><h3 id="Openstack的代码评审系统"><a href="#Openstack的代码评审系统" class="headerlink" title="Openstack的代码评审系统"></a>Openstack的代码评审系统</h3><p>Openstack主要使用Gerrit进行代码评审及管理。社区的Gerrit运行于&lt;review.openstack.org&gt;。Gerrit工作流如下：<br> <img src="/img/gerrit-workflow.png" alt="gerrit工作流"><br>当贡献者向Openstack提交一个patch时，他会将代码提交至由Girrit管理的git服务器上。Gerrit控制着哪个用户或组织可以提交代码、合并代码、管理代码库。当贡献者提交代码至review.openstack.org时，Gerrit会创建一个变更集（Changeset）来代表所提交的代码。原提交者和其它贡献者可以对变更集提交额外的修改。Gerrit会收集所有这些更改而汇集成变更集记录。以下为一个待评审的变更集，其中可以看到有很多Patch，而每个Patch都是对原始提交的一次修改。<br><img src="/img/gerrit-patch.png" alt="gerrit patch界面"><br>Gerrit中的每个Patch都有三个标签属性。每个人都可以评论变更集或评审代码。在Patch标签属性的“Code-Review”一列中显示了对代码的所有评审：<br><img src="/img/gerrit-patch-tabs.png" alt="gerrit review"></p><p>非Openstack核心团队的人员可以在评审代码后作出+1（好）、0（无评价）、-1（不建议合并）的评价。核心团队的成员可以给出非核心成员可给出的所有评价，此外还可以给出+2（好，approved）、-2评价（不要提交）。</p><p>标签属性中另外一列为“Verified”。只有Gerrit的非交互用户（non-interactive users）如Jenkins，才能在此属性上添加Verified标签。Verified一列可设置的值为+1（check pipeline测试通过）、-1（check pipeline测试未通过）、+2（gate pipeline测试通过）、-2（gate pipeline测试未通过）。此外，第三方搭建的外部测试平台也属于非交互用户，但是只能设置+1、-1。</p><p>标签属性中最后一列为Workflow（原为Approve）。只有核心团队的成员可对此列进行标注。此列值只能为+1（Approved）、未通过，展现形式为有无对号标记：<br><img src="/img/gerrit-patch-verify.png" alt="gerrit verify"></p><h3 id="The-“Gate”"><a href="#The-“Gate”" class="headerlink" title="The “Gate”"></a>The “Gate”</h3><p>这里所说的Gate是一个流程、一个动作，通过这个流程、动作，相关条件达不到的代码将被隔离在源代码分支之外，从而完成对目标代码的“守卫”。<br><img src="/img/git-branches.png" alt="git工作流"><br>Openstack采用一种称之为“Non-Human Gatekeeper”的模型来控制代码合并进特定代码分支。Gerrit就是其中的“the non-human”，它允许“Non-Interactive Users”合并代码到它管理的稳定的主干代码分支中。上游的Jenkins服务器以及运行于第三方环境中的Jenkins系统，就属于这些“Non-Interactive Users”。</p><p>那么这些“Non-Interactive Users”如何去判断是否将一个提交的Patch合并进目标代码分支呢？这是通过运行一些相关的测试来实现的。测试内容因项目不同而不同，但大体包括这些内容：单元测试、功能测试、集成测试、升级测试和代码风格测试。“Non-Interactive Users”通过这些测试来守卫（gate）一个特定项目的源代码树。</p><p>大多数Openstack项目都有单元测试和代码风格测试。单元测试在不同的Python版本上执行。风格测试用于验证代码风格是否符合Openstack Hacking和PEP8规定。单元测试和风格测试通过tox调用virtualenvs实现。</p><p>此外，还有针对完整安装的Openstack进行的集成测试。这部分测试时Tempest套件的一部分。最后，很多项目还有升级测试和数据库迁移测试包含在gate test中。</p><h2 id="社区CI环境简介"><a href="#社区CI环境简介" class="headerlink" title="社区CI环境简介"></a>社区CI环境简介</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在未出现标准的自动化CI测试套件之前，社区的代码质量基本都由代码评审人员在本地手工测试保证。执行效率低，需要不断重复，而且因为对完整的环境测试很困难导致很难保证某个模块的修改对其它模块是否会产生影响。此外也无法验证在不同环境下是否运行正常。</p><p>而这一切都在社区的自动化CI测试套件出现后得到改善。这是一个完整的、标准化的、鲁棒性高的、自动化的持续集成测试平台，由社区的openstack-infra开发维护。它的核心是Gerrit代码控制评审平台、Zuul驱动的Gating System和Jenkins CI服务器。这个测试系统已被广泛使用，截止2013年9月，社区持续集成测试平台每小时执行720个测试任务，测试节点已增加至328个，不断并行进行测试。截止I版本，社区大概每天有400个测试通过的提交。</p><h3 id="Test-Run-Style"><a href="#Test-Run-Style" class="headerlink" title="Test Run Style"></a>Test Run Style</h3><p>根据测试目的、测试精度、测试可靠度等的不同，社区的测试运行方式分为以下五种。</p><ul><li>Experimental<br>根据开发者的需要进行的实验性质的、低可靠度的测试。执行失败后的处理并不由openstack-infra团队负责。</li><li>Silent<br>因为已知问题无法进行的测试。其它同Check。社区会寻找解决办法并评定是否可进入到Check状态。</li><li>Third Party<br>由第三方组织（非Openstack-Infra）在自己的测试环境执行的测试。因为第三方不可控，无法保证测试的可靠度。因此虽然执行后可根据结果对所测试的Patch做出评定，但是只能给出+1、-1，无法做出+2（verified）操作。</li><li>Check<br>Check用于验证每个对Gerrit提交的patch。它和第三方的运行机制相同，都是对提交的patch单独进行测试，而不是针对patch被合并进主代码库后的状态进行测试。<br>Check阶段出现的错误会使patch无法被approve，从而无法进入后续状态。<br>因此，Check必须在高度可靠地环境中运行，必须由Infra团队完全控制且隔离。</li><li>Gate<br>Gate旨在检测approve通过后的Patch。与Check不同的是，它针对patch被合并进主代码库后的状态进行测试，而不是提交的代码的状态。这样就会检测到Patch直接的语义冲突等问题（鉴于社区每天会有很多patch经过Gate，这样做是很重要的）。<br>如果Gate发现错误，将会阻断patch的“着陆”（landing），而且它之后的所有等待的patch都要重新进行测试。<br>同Check，Gate也要在高度可靠的环境中运行。</li></ul><h3 id="Openstack-CI工作流程"><a href="#Openstack-CI工作流程" class="headerlink" title="Openstack CI工作流程"></a>Openstack CI工作流程</h3><ul><li>(1a)贡献者提交新patch（主要执行Check测试），<br>或者</li><li>(1b)核心团队成员Approve一个patch（主要执行Gate测试），<br>之后，</li><li>(2)Geriit提交一个通知事件到它的事件流中（event stream），</li><li>(3)Zuul从Gerrit的事件流中读取事件，</li><li>(4)然后匹配事件到一个或多个pipeline，</li><li>(5)Zuul针对patch对应的项目执行pipeline（调用Jenkins执行Jenkins jobs），</li><li>(6)Jenkins被调用来执行具体任务（编译、执行等），并返回结果到Jenkins的事件流中，</li><li>(7)Zuul从Jenkins的事件流中读取事件，</li><li>(8)根据结果，Zuul在Gerrit中对patch添加一个review结果。</li></ul><p><img src="/img/openstack-ci-process.png" alt="Openstack CI工作流程"></p><h3 id="社区CI使用的设备"><a href="#社区CI使用的设备" class="headerlink" title="社区CI使用的设备"></a>社区CI使用的设备</h3><p>社区并无自己的设备，所有环境都是Rackspace、HP等云厂商捐赠的虚拟机实例。<br>2014年6月：目前大概有340个实例并行执行。实例大多本身运行于Openstack之上，具有8G RAM及相关配置，使用Ubuntu Precise系统。</p><h2 id="组件工作流程"><a href="#组件工作流程" class="headerlink" title="组件工作流程"></a>组件工作流程</h2><p>各组件的工作流程图如下：<br><img src="/img/openstack-ci-modules.png" alt="CI各组件工作流程"></p><h3 id="Gerrit"><a href="#Gerrit" class="headerlink" title="Gerrit"></a>Gerrit</h3><p>Gerrit主要负责代码的管理，具体可查看之前的章节。在Gerrit将通知事件添加到Gerrit事件流之后，Zuul组件开始发挥作用。</p><h3 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h3><p>Zuul通过Gerrit事件，找到对应的pipeline进行后续处理。而pipeline中定义了需要执行哪些Jenkins任务。这些都是在Zuul的配置文件layout.yaml中定义的。例如如下为一个gate这个pipeline的片段：<br></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gate</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Changes</span> <span class="string">that</span> <span class="string">have</span> <span class="string">been</span> <span class="string">approved</span> <span class="string">by</span> <span class="string">core</span> <span class="string">developers...</span></span><br><span class="line">    <span class="attr">failure-message:</span> <span class="string">Build</span> <span class="string">failed.</span> <span class="string">For</span> <span class="string">information</span> <span class="string">on</span> <span class="string">how</span> <span class="string">to</span> <span class="string">proceed...</span></span><br><span class="line">    <span class="attr">manager:</span> <span class="string">DependentPipelineManager</span></span><br><span class="line">    <span class="attr">precedence:</span> <span class="string">low</span></span><br><span class="line">    <span class="attr">trigger:</span></span><br><span class="line">      <span class="attr">gerrit:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">event:</span> <span class="string">comment-added</span></span><br><span class="line">          <span class="attr">approval:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">approved:</span> <span class="number">1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">event:</span> <span class="string">comment-added</span></span><br><span class="line">          <span class="attr">comment_filter:</span> <span class="string">(?i)^\s*reverify(</span> <span class="string">(?:bug|lp)[\s#:]*(\d+))\s*$</span></span><br><span class="line">    <span class="attr">start:</span></span><br><span class="line">      <span class="attr">gerrit:</span></span><br><span class="line">        <span class="attr">verified:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">success:</span></span><br><span class="line">      <span class="attr">gerrit:</span></span><br><span class="line">        <span class="attr">verified:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">submit:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">failure:</span></span><br><span class="line">      <span class="attr">gerrit:</span></span><br><span class="line">        <span class="attr">verified:</span> <span class="number">-2</span></span><br></pre></td></tr></table></figure><p></p><p>从中我们可以看到gate这个pipeline由gerrit的commit-added + approved或 commit-added +无bug标识的reverify事件触发。成功后会返回verified:2消息给gerrit，失败返回verified:-2。</p><p>类似，check pipeline会被gerrit的patchset-created或recheck事件触发，成功后返回verified:1，失败后返回verified:-1，与Test Run Style描述一致。Openstack的CI环境中主要用到了check、gate、post、pre-release、release、silent、experimental、periodic这几个pipeline，并分别给出了每个项目中这些pipeline对于哪些Jenkins任务。</p><p>而对于每个项目的每个pipeline，需要执行哪些任务，在此配置文件中project一节定义：<br></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openstack/cinder</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">python-jobs</span></span><br><span class="line"><span class="string">...snip...</span></span><br><span class="line">    <span class="attr">gate:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-cinder-requirements</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-tempest-dsvm-full</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-tempest-dsvm-postgres-full</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-tempest-dsvm-neutron</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-tempest-dsvm-large-ops</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-tempest-dsvm-neutron-large-ops</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gate-grenade-dsvm</span></span><br></pre></td></tr></table></figure><p></p><p>上述配置为对于cinder项目的gate这个pipeline，需要执行gate-cinder-requirement到gate-grenade-dsvm这些任务。</p><p>引入Zuul而不是直接使用Gerrit触发Jenkins的原因是，Jenkins每次只能执行一个任务。这种线性执行是因为考虑到复杂的依赖关系，但是这在需要测试的修改数量增加时就会验证影响效率：如果一个测试需要执行1小时，每天只能执行24次测试，只能对24个修改做出验证。通过引入Zuul使Jenkins并发测试成为可能。</p><p>Zuul同时还可以很好的处理具有复杂依赖关系的多个patch。它能监控正在执行的任务，并可提前结束掉因依赖的patch测试失败而必定失败的测试任务。</p><h3 id="Gearman"><a href="#Gearman" class="headerlink" title="Gearman"></a>Gearman</h3><p>在原来的实现中，Zuul完成“事件-pipeline-任务”的匹配后，就可以调用Jenkins执行具体的任务开始实际的测试了。Jenkins用的是master/slave架构，一台master管理所有slave节点。但是Jenkins的设计初衷并不用于并行执行，它设计中某些点使用到了全局锁，因此在Jenkins的slave节点增加到一定数量后（大约100台），Jenkins的master节点就会出现问题而成为瓶颈。同时master节点是单点部署，无法完成HA等处理。为了扩展Jenkins而引入了Gearman。</p><p>加入Gearman后，Zuul不再与Jenkins直接交互，而是提交执行任务的请求给Gearman服务器，由Gearman服务器完成任务的分发。测试节点通过注册到Gearman服务器，使得Gearman获知其可用，并被分配任务。如Jenkins Master节点通过Gearman的插件连接到Gearman服务器并获得任务。</p><p>通过Gearman，CI测试架构具有了弹性：触发事件的可以不只是Zuul，而执行任务的可以不只是Jenkins。而通过多个Jenkins Master的部署，获得了HA功能。</p><h3 id="Jenkins、JJB"><a href="#Jenkins、JJB" class="headerlink" title="Jenkins、JJB"></a>Jenkins、JJB</h3><p>经过上述流程，终于到了Jenkins实际执行的流程。CI环境中使用的是Master/Salve架构，同一个Master同时控制多个Slave节点进行工作。</p><p>每个Jenkins任务都需要配置Jenkins的config.xml文件实现。而在任务数量达到一定级别后，手工去配置每个任务会变得非常复杂。因此引入了Jenkins Job Builder (JJB)这个Python工具。JJB通过解析用户配置的YAML文件来自动生成config.xml。而YAML文件使用比较易读的语法，支持弹性的模板系统，且支持版本控制便于不断修改。这些特性使得配置大量Jenkins任务变得容易。</p><p>Zuul并不去指定具体Jenkins任务是什么，而是只指定对一个项目的一个pipeline需要去执行哪些Jenkins任务。具体指定每个Jenkins任务的内容是由JJB来做的。</p><p>在Jenkins的任务中，完成对代码的check out、build，然后进行按照定义进行实际的测试。</p><h3 id="Devstack、Nodepool和Backup"><a href="#Devstack、Nodepool和Backup" class="headerlink" title="Devstack、Nodepool和Backup"></a>Devstack、Nodepool和Backup</h3><p>对于单元测试等可能不需要实际的Openstack环境去执行，而对于集成测试等则需要一整套的Openstack组件。对于这些测试， Jenkins任务会去实际搭建完整的Openstack环境。这个工作通过Devstack-Gate调用Devstack脚本实现。但是因为部署也属于Openstack的一部分特性，因此H版本之后社区正在考虑将部署部分也纳入测试项，替代Devstack。</p><p>测试中支持配置不同的组件，如替换数据库PostgreSQL，替换消息队列为ZMQ。</p><p>而在搭建环境之前还需要去申请搭建环境需要的资源（目前社区使用的是虚拟机实例）。Nodepool实现了资源的有效调度，并可方便的添加资源进入资源池。</p><p>在资源使用后，需要清空配置还原环境。这个是通过脚本恢复备份来实现的。</p><h3 id="实际执行的测试用例"><a href="#实际执行的测试用例" class="headerlink" title="实际执行的测试用例"></a>实际执行的测试用例</h3><p>实际执行的测试用例也是在Jenkins的任务中定义，大多通过调用Tempest集成测试套件中的用例实现。</p><h3 id="ELK集群、elastic-recheck"><a href="#ELK集群、elastic-recheck" class="headerlink" title="ELK集群、elastic-recheck"></a>ELK集群、elastic-recheck</h3><p>日志及检索，通过ELK技术栈，实现日志的实时监控：</p><ul><li>Logstash收集日志，实际环境可考虑使用更加节省资源的Heka替换。</li><li>Elasticsearch进行日志分析</li><li>Kibana进行可视化展示</li><li>elastic-recheck跟踪Openstack Gate失败情况</li></ul><h3 id="其它组件"><a href="#其它组件" class="headerlink" title="其它组件"></a>其它组件</h3><ul><li>Puppet，用于自动化部署；</li><li>Cacti等，用于监控。</li></ul><h2 id="测试覆盖内容"><a href="#测试覆盖内容" class="headerlink" title="测试覆盖内容"></a>测试覆盖内容</h2><h3 id="Style测试"><a href="#Style测试" class="headerlink" title="Style测试"></a>Style测试</h3><p>严格的pep8要求，及Openstack自身对代码风格的要求。</p><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>通过Python脚本实现。主要通过python的unittest、mock和nose等单元测试库实现。</p><h3 id="Tempest"><a href="#Tempest" class="headerlink" title="Tempest"></a>Tempest</h3><p>Tempest是一整套Openstack集成测试框架，它的实现基于python的unittest2测试框架和nose测试框架。Tempest对Openstack终端发起一系列API请求，并且对终端的响应进行验证。Tempest通过config文件来描述整个测试环境，包括compute API端点，Keystone server以及Glance server安装的镜像的UUID等信息。</p><p>测试的主要模块有如下几部分：</p><ul><li>api主要测试OpenStack API部分的功能</li><li>cli主要测试OpenStack CLI接口</li><li>scenario主要根据一些复杂场景进行测试</li><li>stress压力测试部分，目前可以结合rally进行压力测试</li><li>thirdparty这部分主要针对于EC2的API测试用例。</li></ul><h3 id="稳定性测试"><a href="#稳定性测试" class="headerlink" title="稳定性测试"></a>稳定性测试</h3><p>可以通过改写Tempest实现，增加功能测试的时间、场景的复杂度，增加一定的负载，即可实现满足要求的稳定性测试。</p><h3 id="性能-压力测试"><a href="#性能-压力测试" class="headerlink" title="性能/压力测试"></a>性能/压力测试</h3><p>目前有Rally、scalability testing项目去实现。因为对运行环境有要求、负载压力较大，而且可能包含调优工作（此时可能会改变部署环境等），所以虽然已集成到CI环境中，但后续可能需要单独进行测试。</p><h3 id="其它测试"><a href="#其它测试" class="headerlink" title="其它测试"></a>其它测试</h3><p>很多项目中还在gate的测试中包含升级和数据库迁移测试（如turbo-hipster）。在原有数据量比较大的情况下，就需要考虑升级测试。<br>还有很多测试未包含，但是社区在不断完善加入新的测试。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>作为Openstack开发厂商，如何集成社区的CI框架到我们的开发过程中呢？</p><ul><li>测试我们的产品质量<br>Openstack社区有兼容性认证，对社区版本做出修改后仍能通过社区测试用例即可获得此认证。<br>另外，为社区提交的patch都需要有严格全面的测试用例。<br>还可以考虑将社区的CI流程集成进自己的开发流程内，但修改对应的测试用例需要自行编写维护。</li><li>为社区捐赠云主机加入社区的测试环境<br>可及时获得社区的修改，是否适用于我们的环境，并跟踪bug修改。<br>目前各大openstack公有云厂商都有参与。</li></ul><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul><li>测试覆盖不全面<br>旧版本只有Nova测试比较多，其他测试待完善。定制化的特性缺少。而且测试大多由开发人员编写，难以保证覆盖度。<br>经过几个大版本的更新，测试覆盖度已达到提高，足够满足要求。<br>只有在新创建的项目里，测试用例要求不严，覆盖度不高。</li><li>Gerrit组件带来的修改<br>我们现在一般都使用gitlab维护代码。而gerrit本身也最适合只做代码review。<br>因此需要迁移代码至gerrit，改变开发review流程，并最终自动同步代码至gitlab。<br>相关配置可参考社区文档。</li><li>自动化部署<br>官方使用devstack进行自动化部署，定制化的部分需要修改。</li><li>组件多，部署配置复杂<br>部分组件如zuul，是Openstack CI团队独立开发，文档较少。<br>而这些组件并非必须，实际环境中乐意考虑简化，最简单的CI框架只需要Gerrit+Jenkins+测试机器+测试用例即可。</li><li>社区CI运行于Ubuntu系统<br>只有针对此系统的依赖及puppet脚本。<br>其它系统部署时在依赖及自动化部署方面可能会遇到很多问题。</li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> bingostack</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://bingostack.com/2014/06/openstack-ci/" title="Openstack CI持续集成测试简介">http://bingostack.com/2014/06/openstack-ci/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/openstack/" rel="tag"># openstack</a> <a href="/tags/ci/" rel="tag"># ci</a> <a href="/tags/持续集成/" rel="tag"># 持续集成</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2013/09/auto-testing-summary/" rel="next" title="自动化测试实践：自动化测试的思考总结"><i class="fa fa-chevron-left"></i> 自动化测试实践：自动化测试的思考总结</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2014/08/rpmbuild-in-action/" rel="prev" title="rpmbuild实战">rpmbuild实战<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"> <span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/img/avatar.jpg" alt="bingostack"><p class="site-author-name" itemprop="name">bingostack</p><p class="site-description motion-element" itemprop="description">软件工程师的自我修养</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">47</span> <span class="site-state-item-name">标签</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#测试的分类及必要性"><span class="nav-number">1.</span> <span class="nav-text">测试的分类及必要性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#测试的分类"><span class="nav-number">1.1.</span> <span class="nav-text">测试的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#按照测试过程分类"><span class="nav-number">1.1.1.</span> <span class="nav-text">按照测试过程分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#按照测试侧重点的不同分类"><span class="nav-number">1.1.2.</span> <span class="nav-text">按照测试侧重点的不同分类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#软件测试的必要性"><span class="nav-number">2.</span> <span class="nav-text">软件测试的必要性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关概念"><span class="nav-number">3.</span> <span class="nav-text">相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#持续集成测试"><span class="nav-number">3.1.</span> <span class="nav-text">持续集成测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么需要持续集成？"><span class="nav-number">3.2.</span> <span class="nav-text">为什么需要持续集成？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Openstack的代码评审系统"><span class="nav-number">3.3.</span> <span class="nav-text">Openstack的代码评审系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-“Gate”"><span class="nav-number">3.4.</span> <span class="nav-text">The “Gate”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#社区CI环境简介"><span class="nav-number">4.</span> <span class="nav-text">社区CI环境简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#背景"><span class="nav-number">4.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-Run-Style"><span class="nav-number">4.2.</span> <span class="nav-text">Test Run Style</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Openstack-CI工作流程"><span class="nav-number">4.3.</span> <span class="nav-text">Openstack CI工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#社区CI使用的设备"><span class="nav-number">4.4.</span> <span class="nav-text">社区CI使用的设备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件工作流程"><span class="nav-number">5.</span> <span class="nav-text">组件工作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Gerrit"><span class="nav-number">5.1.</span> <span class="nav-text">Gerrit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zuul"><span class="nav-number">5.2.</span> <span class="nav-text">Zuul</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gearman"><span class="nav-number">5.3.</span> <span class="nav-text">Gearman</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins、JJB"><span class="nav-number">5.4.</span> <span class="nav-text">Jenkins、JJB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Devstack、Nodepool和Backup"><span class="nav-number">5.5.</span> <span class="nav-text">Devstack、Nodepool和Backup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实际执行的测试用例"><span class="nav-number">5.6.</span> <span class="nav-text">实际执行的测试用例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ELK集群、elastic-recheck"><span class="nav-number">5.7.</span> <span class="nav-text">ELK集群、elastic-recheck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它组件"><span class="nav-number">5.8.</span> <span class="nav-text">其它组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试覆盖内容"><span class="nav-number">6.</span> <span class="nav-text">测试覆盖内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Style测试"><span class="nav-number">6.1.</span> <span class="nav-text">Style测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单元测试"><span class="nav-number">6.2.</span> <span class="nav-text">单元测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tempest"><span class="nav-number">6.3.</span> <span class="nav-text">Tempest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#稳定性测试"><span class="nav-number">6.4.</span> <span class="nav-text">稳定性测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#性能-压力测试"><span class="nav-number">6.5.</span> <span class="nav-text">性能/压力测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它测试"><span class="nav-number">6.6.</span> <span class="nav-text">其它测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用方式"><span class="nav-number">7.1.</span> <span class="nav-text">使用方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题"><span class="nav-number">7.2.</span> <span class="nav-text">问题</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">bingostack</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">55.4k</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html>